# Implementation Plan

## Scope

Google OAuth 認証（Requirement 1）、サインインページ統合（Requirement 5 の Google 関連部分）、およびオンボーディングフロー（Requirement 4）を対象とする。

## Tasks

- [x] 1. Google OAuth 環境変数の追加
  - `.env.example` に `GOOGLE_CLIENT_ID` と `GOOGLE_CLIENT_SECRET` のエントリを追加する
  - Google Cloud Console での OAuth クライアント作成・リダイレクト URI 設定に必要な情報をコメントで補足する
  - サーバー設定（`lib/auth.ts`）は既に `socialProviders.google` を参照済みのため、環境変数の定義のみで認証フローが有効になることを確認する
  - _Requirements: 1.1, 1.2_

- [x] 2. サインインページに Google OAuth ボタンを追加
- [x] 2.1 (P) Google アイコンコンポーネントの用意
  - lucide-react に Google アイコンが含まれないため、SVG ベースの Google アイコンコンポーネントを作成する
  - 既存の GitHub アイコン（`lucide-react` の `Github`）と同等のサイズ・スタイルで統一する
  - _Requirements: 1.1, 5.1_

- [x] 2.2 Google OAuth 認証ハンドラとボタンの実装
  - 既存の `handleGitHubSignIn` と同一パターンで `handleGoogleSignIn` を実装する（`provider: "google"` を指定）
  - `isLoading` 状態の共有管理により、認証フロー中は全ボタンを無効化する
  - エラー発生時は try/catch で捕捉し、toast 通知と error state の設定を行う（GitHub OAuth と同一パターン）
  - サインインページの OAuth ボタン群に Google ボタンを追加し、Google アイコンを表示する
  - ボタン配置は既存の GitHub OAuth ボタンと同一の UI パターン（`variant="outline"`、フル幅）を維持する
  - _Requirements: 1.1, 1.3, 5.1, 5.2_

- [x] 3. Google OAuth 認証フローの動作検証
  - 開発環境で Google OAuth の認可フロー全体を通して動作確認する（サインインページ → Google ログイン画面 → コールバック → セッション確立 → リダイレクト）
  - 新規ユーザーが Google OAuth でサインアップした場合にアカウントが正しく作成されることを確認する
  - 既に同じメールアドレスで登録済みのユーザーが Google OAuth でログインした場合に、既存アカウントに Google プロバイダーが紐付けされることを確認する
  - Google OAuth 画面でキャンセルした場合やエラー発生時に、サインインページへリダイレクトされエラーメッセージが表示されることを確認する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ]* 4. Google OAuth のテストカバレッジ
  - `handleGoogleSignIn` が `signIn.social` を `provider: "google"` で呼び出すことをユニットテストで検証する
  - `isLoading` 中に全認証ボタンが disabled になることを検証する
  - エラーハンドリング（catch ブロックで toast と error state が設定される）を検証する
  - サインインページにゲスト、メール/パスワード、GitHub、Google の各認証ボタンが正しく表示されることを検証する
  - _Requirements: 1.1, 1.3, 5.1, 5.2_

- [ ] 5. オンボーディング用 DB スキーマ拡張とマイグレーション
  - `users` テーブルにオンボーディング完了フラグ（`onboarding_completed`、boolean モードの integer、デフォルト `false`、NOT NULL）を追加する
  - `users` テーブルにジャンル保存用カラム（`genres`、text 型、NULL 許容）を追加する
  - Drizzle Kit でマイグレーションを生成し、ローカル DB に適用して既存ユーザーデータとの互換性を確認する
  - _Requirements: 4.3_

- [ ] 6. ジャンル定数定義とジャンル一覧取得 API の実装
- [ ] 6.1 (P) ジャンルマスターデータの定数定義
  - フロントエンドとバックエンドの両方から参照できる共有モジュールとして、ジャンル一覧（ID、表示名、オプショナルなアイコン識別子）を定数配列で定義する
  - ジャンルの追加・変更がこのファイルの編集のみで完結するようにする
  - _Requirements: 4.2_

- [ ] 6.2 ジャンル一覧取得 tRPC ルーターの実装
  - `baseProcedure` を使用して認証不要でジャンル一覧を取得できるプロシージャを作成する
  - ジャンル定数配列をそのまま返すシンプルな実装とする
  - ルートルーターにジャンルルーターを登録する
  - _Requirements: 4.2, 6.3_

- [ ] 7. オンボーディング完了 API の実装
  - `protectedProcedure` を使用して認証済みユーザーのみアクセス可能なオンボーディングルーターを作成する
  - 完了プロシージャ: ジャンル ID 配列（空配列許容 = スキップ）を受け取り、`users` テーブルの `onboarding_completed` を `true` に、`genres` を JSON 形式で更新する
  - 受け取ったジャンル ID をマスターデータと照合し、不正な ID が含まれる場合はバリデーションエラーを返す
  - ステータス取得プロシージャ: セッションのユーザー ID からオンボーディング完了状態と選択済みジャンルを返す
  - 冪等な設計とし、既に完了済みのユーザーに対しても成功を返す
  - ルートルーターにオンボーディングルーターを登録する
  - _Requirements: 4.3, 4.7, 6.2_

- [ ] 8. オンボーディング UI の実装
- [ ] 8.1 ジャンル選択コンポーネントの作成
  - ジャンル一覧をカード形式またはチップ形式で表示し、複数選択のトグル操作を受け付けるプレゼンテーションコンポーネントを作成する
  - shadcn/ui のコンポーネント（Button variant="outline" または Toggle）を活用し、選択状態を視覚的に表現する
  - props としてジャンル配列、選択中のジャンル ID 配列、トグルハンドラ、無効化フラグを受け取る
  - _Requirements: 4.2_

- [ ] 8.2 オンボーディング画面の実装
  - tRPC 経由でジャンル一覧を取得し、ジャンル選択コンポーネントに渡すクライアントコンポーネントを作成する
  - 「完了」ボタン（1 つ以上のジャンルが選択されている場合のみ有効）と「スキップ」ボタン（常に有効）を配置する
  - 「完了」クリック時は選択ジャンルを、「スキップ」クリック時は空配列をオンボーディング完了 API に送信する
  - 送信処理中のローディング表示とエラー時の toast 通知を実装する
  - 完了またはスキップ後にメインページへリダイレクトする
  - _Requirements: 4.2, 4.3, 4.4, 4.7_

- [ ] 8.3 オンボーディングページルートの作成
  - `/onboarding` パスにページコンポーネントを配置し、オンボーディング画面を表示する
  - サーバーコンポーネントでセッションを確認し、未認証ユーザーはサインインページへリダイレクトする
  - 既にオンボーディング完了済みのユーザーはメインページへリダイレクトする
  - _Requirements: 4.1, 4.6_

- [ ] 9. オンボーディングガードと保護ページ統合
  - サーバーコンポーネントから呼び出せるオンボーディング状態チェック関数を実装する（セッションからユーザー ID を取得し、DB の `onboarding_completed` フラグを確認する）
  - 匿名ユーザー（`isAnonymous: true`）はオンボーディング対象外としてスキップする
  - 既存の保護ページ（メインページ等）にオンボーディングガードを組み込み、未完了ユーザーを `/onboarding` へリダイレクトする
  - `/onboarding` ページ自体にはガードを適用せず、リダイレクトループを防止する
  - _Requirements: 4.1, 4.5, 4.6_

- [ ] 10. オンボーディングフローの統合動作検証
  - 新規ユーザーがサインアップ後、自動的にオンボーディング画面へリダイレクトされることを確認する
  - ジャンルを選択して完了した場合にジャンルが保存され、メインページへ遷移することを確認する
  - スキップを選択した場合にジャンル未選択のまま完了フラグが設定され、メインページへ遷移することを確認する
  - オンボーディング完了済みユーザーがログインした際にオンボーディングをスキップしてメインページに直接アクセスできることを確認する
  - オンボーディング未完了ユーザーが保護ページに直接アクセスした場合にオンボーディング画面へリダイレクトされることを確認する
  - 匿名ユーザーがオンボーディングなしで保護ページにアクセスできることを確認する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ]* 11. オンボーディングのテストカバレッジ
  - オンボーディング完了プロシージャが有効なジャンル ID で正しくユーザーを更新することを検証する
  - 空配列（スキップ）で完了フラグが設定されることを検証する
  - 不正なジャンル ID でバリデーションエラーが返されることを検証する
  - ジャンル一覧取得プロシージャが全ジャンルを返すことを検証する
  - オンボーディング未完了ユーザーの保護ページアクセス時にリダイレクトされることを検証する
  - _Requirements: 4.1, 4.2, 4.3, 4.5, 4.7, 6.2, 6.3_
