# Implementation Plan

- [x] 1. YouTube動画サービスの基盤構築
- [x] 1.1 インメモリキャッシュ機構の実装
  - TTLベースのキャッシュを構築し、キーとデータの格納・取得・無効化・全クリアの操作を提供する
  - TTL経過後のエントリは読み取り時に自動削除する
  - エントリ数上限（100件）を設けてメモリリークを防止する
  - _Requirements: 1.1_
  - _Contracts: VideoCache Service_

- [x] 1.2 (P) ジャンルマッピング定数の定義
  - アプリ内ジャンルIDからYouTube APIの検索パラメータ（videoCategoryId、検索クエリ）への変換マッピングを定数として定義する
  - 未マッピングジャンルに対するフォールバック値を用意する
  - マッピングの存在確認ヘルパー関数を提供する
  - _Requirements: 3.2, 3.4_
  - _Contracts: GenreMapping Service_

- [x] 1.3 YouTube Data API v3 通信サービスの実装
  - 人気動画取得（videos.list, chart=mostPopular）とジャンル別動画検索（search.list）の2つのAPI呼び出しを実装する
  - APIレスポンスをアプリ内部の動画データ形式に変換する。snippet必須フィールド（title, thumbnails, channelTitle）の存在確認を含む防御的パースを行う
  - ネットワーク障害、クォータ超過、不正レスポンスを分類したエラーハンドリングを提供する
  - APIキーはサーバーサイド環境変数から取得し、クライアントに露出しない
  - キャッシュ機構と統合し、キャッシュヒット時はAPI呼び出しをスキップする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 4.2_
  - _Contracts: YouTubeVideoService Service_

- [x] 2. tRPC動画ルーターの構築
- [x] 2.1 Zodスキーマと動画ルーターの定義
  - 動画データの入出力型をZodスキーマで定義し、型安全性を保証する
  - 人気動画取得のpublicプロシージャ（baseProcedure）を実装する。再生回数・人気度に基づくデータを返却する
  - ジャンル別動画取得のprotectedプロシージャを実装する。認証済みユーザーのジャンル情報をDBから取得し、各ジャンルからバランスよく動画を取得して返却する
  - ジャンル未選択時は人気動画をフォールバックとして返却する
  - ルートルーターに動画ルーターを登録して全体システムに接続する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.3, 3.4, 4.1, 4.3_
  - _Contracts: VideoRouter Service_

- [x] 3. UIコンポーネントの実装
- [x] 3.1 (P) 動画カードコンポーネントの作成
  - サムネイル画像、タイトル、チャンネル名を表示する動画カードを実装する
  - クリックで動画選択を親コンポーネントに通知するハンドラを受け取る
  - _Requirements: 5.2_
  - _Contracts: VideoCard_

- [x] 3.2 (P) セクション見出しコンポーネントの作成
  - ジャンル名や「人気の動画」等のタイトルと配下のコンテンツをグルーピングするラッパーを実装する
  - _Requirements: 5.5_
  - _Contracts: VideoSection_

- [x] 3.3 (P) ローディングスケルトンの作成
  - 動画読み込み中にグリッドレイアウトと同じ形状のプレースホルダーを表示する
  - _Requirements: 5.3_
  - _Contracts: VideoGridSkeleton_

- [x] 3.4 (P) 空状態メッセージコンポーネントの作成
  - 表示可能な動画が存在しない場合に適切なメッセージを表示する
  - _Requirements: 5.4_
  - _Contracts: VideoEmptyState_

- [x] 3.5 動画再生モーダルの実装
  - @next/third-partiesのYouTubeEmbedコンポーネントを使用し、モーダル形式で動画を再生表示する
  - ESCキーやオーバーレイクリックで閉じる操作をサポートし、閉じた際に再生を停止してグリッド表示に復帰する
  - 動画IDが空の場合はレンダリングしない防御処理を含む
  - @next/third-partiesパッケージの依存追加を行う
  - _Requirements: 6.1, 6.2, 6.3_
  - _Contracts: VideoPlayerModal State_

- [x] 4. 動画グリッド統合とメインページ接続
- [x] 4.1 動画グリッドコンポーネントの実装
  - tRPCクエリで人気動画とジャンル別動画を並行取得し、レスポンシブなグリッドレイアウト（モバイル1列、タブレット2列、デスクトップ3-4列）で表示する
  - ローディング中はスケルトン、データ空時は空状態メッセージ、成功時はセクション付きグリッドを切り替え表示する
  - 動画カードクリック時に選択中の動画IDをローカルstateで管理し、再生モーダルを表示する
  - _Requirements: 5.1, 5.5_
  - _Contracts: VideoGrid State_

- [x] 4.2 認証状態に応じた表示制御とメインページへの組み込み
  - 認証済みユーザーには人気動画セクションとジャンル別動画セクションの両方を表示する
  - 未認証ユーザーには人気動画セクションのみ表示し、パーソナライズセクションを非表示にするかログインを促すメッセージを表示する
  - メインページのコンテンツとして動画グリッドを配置し、既存のページ構成と統合する
  - _Requirements: 7.1, 7.2_

- [ ]* 5. 受け入れ基準ベースのテストカバレッジ
- [ ]* 5.1 (P) サービス層のユニットテスト
  - APIレスポンスから動画データ形式への変換ロジックの正常系・異常系を検証する
  - キャッシュのTTL動作（有効期限内の取得、期限切れの取得、無効化）を検証する
  - ジャンルマッピングの全ジャンル解決と未マッピングフォールバックを検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.2_

- [ ]* 5.2 (P) tRPCルーターの統合テスト
  - モックAPIを使用した人気動画取得の正常系フローを検証する
  - ジャンル未選択ユーザーのフォールバック動作を検証する
  - 未認証ユーザーのbyGenresプロシージャ呼び出しが認証エラーとなることを検証する
  - _Requirements: 2.1, 2.3, 2.4, 3.3, 4.1_

- [ ]* 5.3 E2Eテスト
  - 認証済みユーザーがメインページにアクセスし、人気動画セクションとジャンル別セクションが表示されることを確認する
  - 未認証ユーザーがメインページにアクセスし、人気動画セクションのみ表示されることを確認する
  - 動画カードクリックからモーダル再生、閉じる操作までの一連のフローを確認する
  - _Requirements: 5.1, 5.2, 6.1, 6.3, 7.1, 7.2_
